name: TPM Beat1 debug (tcti-lddebug)

on:
  workflow_dispatch: {}

jobs:
  debug-tcti-ld:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y swtpm swtpm-tools tpm2-tools libtss2-tcti-swtpm0 libtpms0 strace jq python3 || true

      - name: Prepare directories
        run: |
          mkdir -p tmp/swtpm-state
          rm -f /tmp/swtpm-sock /tmp/swtpm-ctrl || true

      - name: Start swtpm
        run: |
          set -eu
          SWTPM_LOG=tmp/swtpm.log
          SOCK=/tmp/swtpm-sock
          CTRL=/tmp/swtpm-ctrl
          STATE_DIR=tmp/swtpm-state

          swtpm socket --tpmstate dir="$STATE_DIR" --ctrl type=unixio,path="$CTRL" --server type=unixio,path="$SOCK" --log level=20 > "$SWTPM_LOG" 2>&1 &
          SWTPM_PID=$!
          echo "$SWTPM_PID" > tmp/swtpm.pid

          for i in {1..20}; do
            if [ -e "$SOCK" ]; then break; fi
            sleep 1
          done

          echo "swtpm pid:$SWTPM_PID socket_exists: $( [ -e "$SOCK" ] && echo yes || echo no )"
          ss -lx | sed -n '1,200p' || true

      - name: Verify lib presence
        run: |
          ldconfig -p | grep tss2 || true > tmp/ldconfig-tss2.txt
          ls -l /lib/x86_64-linux-gnu/libtss2-tcti* /usr/lib/*/libtss2* 2>/dev/null || true > tmp/libtss2-list.txt

      - name: LD_DEBUG + strace tpm2_getrandom (capture loader activity)
        run: |
          set -eu
          export TPM2TOOLS_TCTI="swtpm:socket=/tmp/swtpm-sock"
          # Capture loader messages
          LD_DEBUG=files tpm2_getrandom 8 -T "swtpm:socket=/tmp/swtpm-sock" > tmp/tpm2_getrandom.lddebug 2>&1 || true
          # Use strace to capture open/connect/syscalls (do NOT try to trace 'dlopen' as it's not a syscall)
          strace -ff -o tmp/tpm2_getrandom.strace -s 200 -e trace=connect,open,openat,stat,statx,read,write,recvmsg,sendmsg,close -- env TSS2_LOG=all tpm2_getrandom 8 -T "swtpm:socket=/tmp/swtpm-sock" > tmp/tpm2_getrandom.out 2>&1 || true
          env TSS2_LOG=all tpm2_getcap -T "swtpm:socket=/tmp/swtpm-sock" properties-fixed > tmp/tpm2_getcap.out 2>&1 || true

      - name: Collect diagnostics
        run: |
          ls -l tmp > tmp/ls.txt || true
          ss -lx > tmp/ss.txt || true
          lsof -U > tmp/lsof-uds.txt || true
          ps aux > tmp/ps.txt || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tpm-tcti-lddebug
          path: |
            tmp/tpm2_getrandom.strace*
            tmp/tpm2_getrandom.out
            tmp/tpm2_getrandom.lddebug
            tmp/tpm2_getcap.out
            tmp/ldconfig-tss2.txt
            tmp/libtss2-list.txt
            tmp/ls.txt
            tmp/ss.txt
            tmp/lsof-uds.txt
            tmp/ps.txt
            tmp/swtpm.log
            tmp/swtpm.pid
