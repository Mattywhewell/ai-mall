name: Verify SigV4 check on PRs

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  check-sigv4:
    permissions:
      checks: read
    runs-on: ubuntu-latest
    steps:
      - name: Check PR for SigV4 status
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const headSha = context.payload.pull_request.head.sha;

            // Name of the workflow / check we expect. Adjust if your workflow has a different name.
            const requiredCheckName = 'E2E SigV4 checks';

            core.info(`Verifying PR #${prNumber} (sha ${headSha}) for required check: ${requiredCheckName}`);

            // Also check the merge ref (the workflow runs against refs/pull/<pr>/merge)
            const mergeRef = `refs/pull/${prNumber}/merge`;

            // Get check runs for both the head sha and the merge ref
            const { data: headCheckRuns } = await github.rest.checks.listForRef({ owner, repo, ref: headSha });
            const { data: mergeCheckRuns } = await github.rest.checks.listForRef({ owner, repo, ref: mergeRef });

            const combined = [...(headCheckRuns.check_runs || []), ...(mergeCheckRuns.check_runs || [])];
            const matching = combined.filter(c => c.name === requiredCheckName && c.conclusion === 'success');

            if (!matching || matching.length === 0) {
              core.setFailed(`Required check "${requiredCheckName}" has not succeeded for commit ${headSha} or merge ref ${mergeRef}. Please ensure the workflow runs and completes.`);
            } else {
              core.info(`Found successful check run: ${matching.map(m => `${m.name}@${m.head_sha}`).join(', ')}`);
            }
