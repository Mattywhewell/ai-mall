name: Verify SigV4 check on PRs

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  check-sigv4:
    permissions:
      checks: read
    runs-on: ubuntu-latest
    steps:
      - name: Check PR for SigV4 status
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const headSha = context.payload.pull_request.head.sha;

            // Name of the workflow / check we expect. Adjust if your workflow has a different name.
            const requiredCheckName = 'E2E SigV4 checks';

            core.info(`Verifying PR #${prNumber} (sha ${headSha}) for required check: ${requiredCheckName}`);

            // Also check the merge ref (the workflow runs against refs/pull/<pr>/merge)
            const mergeRef = `refs/pull/${prNumber}/merge`;

            // Poll briefly for the required check on head or merge refs to handle race conditions
            const checkForSuccess = async (ref) => {
              const { data } = await github.rest.checks.listForRef({ owner, repo, ref });
              return (data.check_runs || []).some(c => c.name === requiredCheckName && c.conclusion === 'success');
            };

            const refsToCheck = [headSha, mergeRef];
            let found = false;

            for (let attempt = 0; attempt < 12 && !found; attempt++) {
              core.info(`Attempt ${attempt + 1}/12: checking refs ${refsToCheck.join(', ')}`);
              for (const ref of refsToCheck) {
                if (await checkForSuccess(ref)) {
                  found = true;
                  core.info(`Found successful check run for ref ${ref}`);
                  break;
                }
              }

              if (!found) {
                // Wait 5s before retrying
                await new Promise(resolve => setTimeout(resolve, 5000));
              }
            }

            if (!found) {
              core.setFailed(`Required check "${requiredCheckName}" has not succeeded for commit ${headSha} or merge ref ${mergeRef} after waiting. Please ensure the workflow runs and completes.`);
            } else {
              core.info(`Required check "${requiredCheckName}" was found successful.`);
            }
