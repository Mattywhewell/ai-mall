name: Migration Arc - Idempotence Tests

on:
  pull_request:
    paths:
      - 'scripts/migration-arc/**'
      - 'docs/migration-arc.md'

jobs:
  idempotence:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install OpenSSH (ensure ssh-keygen present)
        run: sudo apt-get update && sudo apt-get install -y openssh-client
      - name: Run migration-arc idempotence smoke test
        run: bash ./scripts/migration-arc/tests/test_idempotence.sh
      - name: Run migration-arc cert flow test
        run: bash ./scripts/migration-arc/tests/test_cert_flow.sh
      - name: Run authorized principals (revocation) test
        run: bash ./scripts/migration-arc/tests/test_authorized_principals.sh
      - name: Run authorized principals parsing-variant tests
        run: bash ./scripts/migration-arc/tests/test_authorized_principals_parsing.sh
      - name: Run Scene 5 hardware tests (opt-in)
        run: |
          if [ "${CI_RUN_SCENE5:-false}" = "true" ]; then
            bash ./scripts/migration-arc/tests/test_scene5_hardware_integration.sh
            bash ./scripts/migration-arc/tests/test_scene5_tpm_attestation.sh
          else
            echo "Skipping Scene 5 hardware tests (set CI_RUN_SCENE5=true to run real-hardware tests)"
          fi
      - name: Run simulated sshd integration test
        run: bash ./scripts/migration-arc/tests/test_sshd_simulated.sh
