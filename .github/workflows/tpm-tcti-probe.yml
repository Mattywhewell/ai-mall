name: TPM TCTI probe (dlopen/dlsym)

on:
  workflow_dispatch: {}

jobs:
  probe:
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential gdb libtss2-tcti-swtpm0 libtss2-dev pkg-config swtpm swtpm-tools libtpms0 || true

      - name: Enable core dumps
        run: |
          sudo sysctl -w kernel.core_pattern="tmp/core.%e.%p.%t" || true
          sudo sysctl -w fs.suid_dumpable=2 || true
          echo "core_pattern=$(cat /proc/sys/kernel/core_pattern)" > tmp/core_setup.txt
          ulimit -c unlimited || true
          echo "ulimit: $(ulimit -c)" >> tmp/core_setup.txt || true

      - name: Build probe
        run: |
          gcc -o scripts/tpm/tcti_probe scripts/tpm/tcti_probe.c -ldl || true
          gcc -g -O0 -o tmp/tcti_probe_gdb scripts/tpm/tcti_probe.c -ldl || true
          ls -l scripts/tpm/tcti_probe || true
          ls -l tmp/tcti_probe_gdb || true

      - name: Run probe (no swtpm)
        run: |
          echo "Running probe without swtpm (should show dlopen/dlsym results)" > tmp/probe_no_swtpm.txt
          scripts/tpm/tcti_probe >> tmp/probe_no_swtpm.txt 2>&1 || true
          tail -n +1 tmp/probe_no_swtpm.txt | sed -n '1,200p'

      - name: Run probe under gdb (no swtpm)
        run: |
          echo "Running probe under gdb without swtpm" > tmp/gdb_probe_no_swtpm.txt
          PROBE_SINGLE_PROCESS=1 gdb -batch -ex "set follow-fork-mode child" -ex "run" -ex "bt full" -ex "thread apply all bt full" -ex "info sharedlibrary" -ex "info symbol $pc" -ex "x/20i $pc" --args tmp/tcti_probe_gdb > tmp/gdb_probe_no_swtpm.txt 2>&1 || true
          tail -n +1 tmp/gdb_probe_no_swtpm.txt | sed -n '1,200p'

      - name: Start swtpm and run probe (with socket env)
        run: |
          mkdir -p tmp/swtpm-state
          rm -f /tmp/swtpm-sock /tmp/swtpm-ctrl || true
          swtpm socket --tpmstate dir=tmp/swtpm-state --ctrl type=unixio,path=/tmp/swtpm-ctrl --server type=unixio,path=/tmp/swtpm-sock --log level=20 > tmp/swtpm.log 2>&1 &
          SWTPM_PID=$!
          echo $SWTPM_PID > tmp/swtpm.pid
          for i in {1..30}; do if [ -e /tmp/swtpm-sock ]; then break; fi; sleep 1; done
          echo "Socket exists: $( [ -e /tmp/swtpm-sock ] && echo yes || echo no )"
          echo "Running probe with swtpm up" > tmp/probe_with_swtpm.txt
          scripts/tpm/tcti_probe >> tmp/probe_with_swtpm.txt 2>&1 || true
          tail -n +1 tmp/probe_with_swtpm.txt | sed -n '1,200p'

      - name: Run probe under gdb (with swtpm)
        run: |
          echo "Running probe under gdb with swtpm" > tmp/gdb_probe_with_swtpm.txt
          gdb -batch -ex "set follow-fork-mode child" -ex "run" -ex "bt full" -ex "thread apply all bt full" -ex "info sharedlibrary" -ex "info symbol $pc" -ex "x/20i $pc" --args tmp/tcti_probe_gdb > tmp/gdb_probe_with_swtpm.txt 2>&1 || true
          tail -n +1 tmp/gdb_probe_with_swtpm.txt | sed -n '1,200p'

      - name: Collect core dumps (if any) and produce gdb backtraces
        run: |
          echo "Looking for core files..." > tmp/core_list.txt
          ls -la tmp/core.* >> tmp/core_list.txt 2>&1 || true
          for c in tmp/core.*; do
            if [ -e "$c" ]; then
              pfx=$(basename "$c")
              echo "Processing $c" >> tmp/core_list.txt
              # Attempt gdb backtrace against probe binary
              gdb -batch -ex "thread apply all bt full" -ex "info sharedlibrary" -ex "info symbol \$pc" -ex "x/20i \$pc" tmp/tcti_probe_gdb "$c" > "tmp/core_bt_${pfx}.txt" 2>&1 || true
            fi
          done || true

      - name: Upload probe artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tpm-tcti-probe
          path: |
            tmp/probe_no_swtpm.txt
            tmp/probe_with_swtpm.txt
            tmp/gdb_probe_no_swtpm.txt
            tmp/gdb_probe_with_swtpm.txt
            tmp/core_list.txt
            tmp/core_bt_*
            tmp/swtpm.log
            tmp/swtpm.pid
