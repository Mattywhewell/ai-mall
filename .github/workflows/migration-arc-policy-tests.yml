name: Migration Arc â€” Policy Tests

on:
  pull_request:
    paths:
      - 'scripts/migration-arc/**'
      - '.github/workflows/migration-arc-policy-tests.yml'
  push:
    branches:
      - 'chore/scene5c-add-policy-wiring'

jobs:
  migration-arc-tests:
    name: migration-arc tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Ensure test scripts executable
        run: |
          chmod +x scripts/migration-arc/tests/*.sh || true
          chmod +x scripts/migration-arc/authorized_principals_command.sh || true

      - name: Run migration-arc tests
        run: |
          set -euo pipefail
          mkdir -p test-logs
          echo "Running migration-arc tests..."
          overall_rc=0
          for f in scripts/migration-arc/tests/*.sh; do
            echo "=== RUN $f ==="
            bash -x "$f" > "test-logs/$(basename "$f").log" 2>&1 || rc=$? && rc=${rc:-0}
            if [ ${rc:-0} -ne 0 ]; then
              echo "Test failed: $f (rc=$rc). See test-logs/$(basename "$f").log"
              overall_rc=1
            else
              echo "=== PASS $f ==="
            fi
          done
          echo "All migration-arc tests completed; overall rc=$overall_rc"
          # Print logs for quick debugging in GH UI
          echo "---- test logs start ----"
          for l in test-logs/*.log; do
            echo "=== $l ==="; sed -n '1,200p' "$l" || true; echo "...";
          done
          echo "---- test logs end ----"
          if [ $overall_rc -ne 0 ]; then
            exit 1
          fi

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        with:
          name: migration-arc-test-logs
          path: test-logs
