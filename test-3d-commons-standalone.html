<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Commons Test - Standalone</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@react-three/fiber@8.15.19/dist/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@react-three/drei@9.105.6/dist/index.umd.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
        }
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
        }
        #status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        .error {
            background: rgba(255, 0, 0, 0.8) !important;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="ui">
            <h2>3D Commons Test</h2>
            <button onclick="testBasicScene()">Test Basic Scene</button>
            <button onclick="testLighting()">Test Lighting</button>
            <button onclick="testGeometry()">Test Geometry</button>
            <button onclick="testControls()">Test Controls</button>
            <div id="status">Initializing 3D environment...</div>
        </div>
        <div id="canvas"></div>
    </div>

    <script>
        let React, ReactDOM, THREE, ReactThreeFiber, Drei;
        let scene, camera, renderer, controls;
        let isInitialized = false;

        // Initialize Three.js extensions for React Three Fiber
        function initializeThreeExtensions() {
            if (typeof window !== 'undefined' && window.THREE) {
                THREE = window.THREE;

                // Extend THREE.js objects for React Three Fiber compatibility
                if (window.ReactThreeFiber && window.ReactThreeFiber.extend) {
                    window.ReactThreeFiber.extend({
                        // Basic objects
                        Mesh: THREE.Mesh,
                        Group: THREE.Group,
                        Scene: THREE.Scene,

                        // Geometries
                        BoxGeometry: THREE.BoxGeometry,
                        SphereGeometry: THREE.SphereGeometry,
                        PlaneGeometry: THREE.PlaneGeometry,
                        CylinderGeometry: THREE.CylinderGeometry,

                        // Materials
                        MeshBasicMaterial: THREE.MeshBasicMaterial,
                        MeshStandardMaterial: THREE.MeshStandardMaterial,
                        MeshLambertMaterial: THREE.MeshLambertMaterial,

                        // Lights
                        AmbientLight: THREE.AmbientLight,
                        DirectionalLight: THREE.DirectionalLight,
                        PointLight: THREE.PointLight,

                        // Camera
                        PerspectiveCamera: THREE.PerspectiveCamera,

                        // Add Polygon as ShapeGeometry (fixes the namespace error)
                        Polygon: THREE.ShapeGeometry,

                        // Other common objects
                        Color: THREE.Color,
                        Vector3: THREE.Vector3,
                        Euler: THREE.Euler,
                        Fog: THREE.Fog,
                    });
                }

                updateStatus('Three.js extensions initialized');
                return true;
            }
            return false;
        }

        // Initialize React Three Fiber
        function initializeReactThree() {
            if (typeof window !== 'undefined') {
                React = window.React;
                ReactDOM = window.ReactDOM;

                if (window.ReactThreeFiber) {
                    ReactThreeFiber = window.ReactThreeFiber;
                }

                if (window.Drei) {
                    Drei = window.Drei;
                }

                updateStatus('React Three Fiber initialized');
                return true;
            }
            return false;
        }

        // Initialize basic Three.js scene
        function initializeBasicScene() {
            try {
                // Create scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB); // Sky blue
                scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

                // Create camera
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 5, 10);
                camera.lookAt(0, 0, 0);

                // Create renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                // Add renderer to DOM
                const canvasContainer = document.getElementById('canvas');
                if (canvasContainer) {
                    canvasContainer.appendChild(renderer.domElement);
                }

                // Add basic lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                scene.add(directionalLight);

                // Add ground plane
                const groundGeometry = new THREE.PlaneGeometry(50, 50);
                const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                scene.add(ground);

                // Add OrbitControls
                if (window.THREE && window.THREE.OrbitControls) {
                    controls = new window.THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                }

                // Animation loop
                function animate() {
                    requestAnimationFrame(animate);

                    if (controls) {
                        controls.update();
                    }

                    renderer.render(scene, camera);
                }
                animate();

                isInitialized = true;
                updateStatus('Basic 3D scene initialized successfully!');
                return true;

            } catch (error) {
                updateStatus('Failed to initialize basic scene: ' + error.message, true);
                console.error('Scene initialization error:', error);
                return false;
            }
        }

        // Test functions
        function testBasicScene() {
            if (!isInitialized) {
                updateStatus('Initializing scene first...', true);
                if (!initializeBasicScene()) {
                    return;
                }
            }
            updateStatus('Basic scene test passed! 3D environment is working.');
        }

        function testLighting() {
            if (!isInitialized || !scene) {
                updateStatus('Initialize basic scene first', true);
                return;
            }

            // Add a test light
            const testLight = new THREE.PointLight(0xff0000, 1, 10);
            testLight.position.set(5, 5, 0);
            scene.add(testLight);

            updateStatus('Lighting test: Added red point light');
        }

        function testGeometry() {
            if (!isInitialized || !scene) {
                updateStatus('Initialize basic scene first', true);
                return;
            }

            // Add test geometry
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
            const cube = new THREE.Mesh(geometry, material);
            cube.position.set(0, 3, 0);
            cube.castShadow = true;
            scene.add(cube);

            updateStatus('Geometry test: Added green cube');
        }

        function testControls() {
            if (!isInitialized || !controls) {
                updateStatus('Initialize basic scene first', true);
                return;
            }

            // Test controls by moving camera
            camera.position.set(10, 10, 10);
            controls.target.set(0, 0, 0);
            controls.update();

            updateStatus('Controls test: Moved camera position');
        }

        function updateStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = isError ? 'error' : '';
            }
            console.log(message);
        }

        // Initialize everything when page loads
        window.onload = function() {
            console.log('Page loaded, initializing 3D environment...');

            // Wait for scripts to load
            setTimeout(() => {
                if (initializeThreeExtensions() && initializeReactThree()) {
                    updateStatus('All libraries loaded. Click "Test Basic Scene" to begin.');
                } else {
                    updateStatus('Failed to load required libraries', true);
                }
            }, 1000);
        };

        // Handle window resize
        window.addEventListener('resize', function() {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>