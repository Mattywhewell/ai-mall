# Local introspection (run & handoff)

This document explains how to run local introspection, what outputs to expect, and how to hand the artifact off to the DB team for patching.

Prerequisites
- Node 18+ installed.
- `git` and `zip` or Python available.
- `DOTENV` usage: put `SUPABASE_DATABASE_URL` in `.env.local` or export it in the environment.

Quick run (local):
- Bash: `./scripts/introspect-local.sh`
- PowerShell: `.\scripts\introspect-local.ps1`

What the wrapper does
- Loads `.env.local` if present (`DOTENV_CONFIG_PATH`)
- Runs `ci-supabase-dbconnect.js` → `dbconnect.log`
- Runs `ci-supabase-introspect.js` → `supabase-introspect.log`
- Copies context files (`supabase-auth-fixes.sql` etc.) into a timestamped log dir
- Zips the log directory to `supabase-migrations-logs-<timestamp>.zip` and prints the path

Expected outputs (short)
- `dbconnect.log` → contains either `SSL OK` / successful connection or `ETIMEDOUT` / connection errors
- `supabase-introspect.log` → notes about `exec_sql` availability, schema-cache errors, or successful introspection
- `schema.json` (if generated by introspection) → full schema dump (tables/columns)
- `functions.json` → RPC + SQL functions list
- `triggers.json` → triggers and dependencies
- `supabase-migrations-logs-<timestamp>.zip` → packaged artifact to hand off

Handoff checklist (for DB team)
- Attach the artifact (release/gist or upload to the issue) using the Issue template: **Supabase Introspection Artifact Attached**
- Provide these details in the issue body:
  - Timestamp
  - Host used (supabase project URL)
  - Exact command executed
  - Runner (local / VM / self-hosted)
  - Key signals from logs: `dbconnect` (ETIMEDOUT / OK), `introspect` (exec_sql missing / schema-cache delay / OK)

Requested DB-team actions
1. Parse introspection output and list any objects referencing `user_role`.
2. Produce idempotent SQL patches to remove/modify references or add missing types/functions.
3. Validate RLS policies (e.g., `public.agent_communications`) and missing grants.
4. Confirm admin API (`createUser`) works locally after patches.

Notes & troubleshooting
- If `exec_sql` appears missing from PostgREST schema-cache, re-run `./scripts/introspect-local.sh` after 1–2 minutes; PostgREST may take a short time to refresh newly-created RPCs.
- If GitHub Actions cannot reach the DB, run this on a reachable VM or self-hosted runner in the same network, then attach the artifact.

Example Issue (copy into new issue using template)
- Timestamp: `2026-01-19T11:00Z`
- Host: `wmiqtmtjhlpfsjwjvwgl.supabase.co`
- Command: `./scripts/introspect-local.sh`
- Runner: `local` (Ubuntu 22.04)
- Artifact: `supabase-migrations-logs-20260119T110000Z.zip`
- Key signals:
  - dbconnect: `ETIMEDOUT`
  - introspect: `exec_sql missing`

---

## Triggering automated parsing via `/introspect` (optional)

If you uploaded the introspection zip as a GitHub Release or hosted it at a reachable URL (gist/raw zip), you can trigger the automated parser by commenting on the issue:

`/introspect <url>`

The repository's automation will download the zip, run `scripts/parse-introspection.js`, post a findings summary, upload parsed artifacts, and apply the `introspection` and `schema-review` labels. Do **not** include secrets in the URL or comment.

